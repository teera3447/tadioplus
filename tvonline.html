<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Tadio+ (Auto Update)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --bg: #0f172a; --panel: #020617; --accent: #38bdf8; --text: #fff; }
        body { margin: 0; font-family: sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        header { padding: 15px; background: var(--panel); text-align: center; border-bottom: 1px solid #1e293b; font-weight: bold; }
        #app { display: flex; height: calc(100vh - 56px); }
        #playerWrap { flex: 1; background: #000; display: flex; flex-direction: column; }
        video { width: 90%; height: 90%; flex: 1; }
        #channels { width: 300px; background: var(--panel); overflow-y: auto; border-left: 1px solid #1e293b; }
        .search-box { padding: 10px; position: sticky; top: 0; background: var(--panel); z-index: 10; }
        input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #334155; background: #1e293b; color: #fff; box-sizing: border-box; }
        .channel { padding: 12px; border-bottom: 1px solid #1e293b; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .channel:hover { background: #1e293b; }
        .channel.active { border-left: 4px solid var(--accent); background: #1e293b; }
        .channel img { width: 30px; height: 30px; object-fit: contain; background: #fff; border-radius: 4px; }
        .controls { padding: 10px; background: var(--panel); display: flex; gap: 10px; align-items: center; }
        @media(max-width: 768px) { #app { flex-direction: column; } #channels { width: 100%; height: 40vh; } }
    </style>
</head>
<body>

<header>Tadio+ ดูทีวีออนไลน์ (Live Sync)</header>

<div id="app">
    <div id="playerWrap">
        <video id="video" controls playsinline></video>
        <div class="controls">
            <select id="qualitySelect" onchange="changeQuality()"><option value="-1">Auto</option></select>
            <small id="status" style="color: #64748b;">กำลังโหลดรายการช่อง...</small>
        </div>
    </div>
    <div id="channels">
        <div class="search-box">
            <input type="text" id="search" placeholder="ค้นหาช่อง..." oninput="filter()">
        </div>
        <div id="list"></div>
    </div>
</div>

<script>
    const M3U_URL = "https://raw.githubusercontent.com/teera3447/tadioplus/refs/heads/main/tadio1.m3u";
    const PROXY = "https://iptv.tadioplus.workers.dev/?url=";
    
    let allChannels = [];
    let hls;
    const video = document.getElementById('video');
    const qSelect = document.getElementById('qualitySelect');

    // 1. ฟังก์ชันดึงข้อมูลจาก M3U และ Parse เป็น JSON
    async function loadM3U() {
        try {
            const response = await fetch(M3U_URL);
            const data = await response.text();
            const lines = data.split('\n');
            const channels = [];
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF:')) {
                    const info = lines[i];
                    const url = lines[i + 1]?.trim();
                    
                    if (url && url.startsWith('http')) {
                        // ดึงชื่อช่อง
                        const name = info.split(',')[1] || "Unknown Channel";
                        // ดึง Logo (ถ้ามี)
                        const logoMatch = info.match(/tvg-logo="([^"]+)"/);
                        const logo = logoMatch ? logoMatch[1] : "";
                        
                        channels.push({ name, url, logo });
                    }
                }
            }
            allChannels = channels;
            render(allChannels);
            document.getElementById('status').innerText = `โหลดเสร็จแล้ว (${allChannels.length} ช่อง)`;
        } catch (error) {
            console.error("Error loading M3U:", error);
            document.getElementById('status').innerText = "โหลดข้อมูลล้มเหลว";
        }
    }

    function fixUrl(url) {
        if (!url.startsWith('https://')) {
            return PROXY + encodeURIComponent(url);
        }
        return url;
    }

    function play(ch, el) {
        const finalUrl = fixUrl(ch.url);
        document.querySelectorAll('.channel').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('status').innerText = "กำลังเล่น: " + ch.name;

        if (hls) hls.destroy();

        if (Hls.isSupported()) {
            hls = new Hls({ xhrSetup: xhr => xhr.withCredentials = false });
            hls.loadSource(finalUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                updateQ();
                video.play();
            });
            hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) document.getElementById('status').innerText = "เกิดข้อผิดพลาดในการโหลดสตรีม";
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = finalUrl;
            video.play();
        }
    }

    function updateQ() {
        qSelect.innerHTML = '<option value="-1">Auto</option>';
        if (hls && hls.levels) {
            hls.levels.forEach((l, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = (l.height || i) + 'p';
                qSelect.appendChild(opt);
            });
        }
    }

    function changeQuality() {
        if (hls) hls.currentLevel = parseInt(qSelect.value);
    }

    function filter() {
        const txt = document.getElementById('search').value.toLowerCase();
        render(allChannels.filter(c => c.name.toLowerCase().includes(txt)));
    }

    function render(data) {
        const container = document.getElementById('list');
        container.innerHTML = "";
        data.forEach(ch => {
            const div = document.createElement('div');
            div.className = 'channel';
            const img = ch.logo ? `<img src="${ch.logo}" onerror="this.style.display='none'">` : '';
            div.innerHTML = `${img} <span>${ch.name}</span>`;
            div.onclick = () => play(ch, div);
            container.appendChild(div);
        });
    }

    // เริ่มโหลดข้อมูลเมื่อเปิดหน้าเว็บ
    loadM3U();
</script>
</body>
</html>
